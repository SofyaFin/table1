# Добро пожаловать в Data Science!

## Нулевая задача
Для корректной работы всего, необходимо доставить несколько вещей:

1) [Python 3.10](https://www.python.org/downloads/release/python-3120/) и выше (ниже не стоит)
2) Любую среду разработки (рекомендую [PyCharm Community Edition](https://www.jetbrains.com.cn/en-us/edu-products/download/other-PCE.html))
3) PostgreSQL ([Виндовс](https://www.postgresql.org/download/windows/), [Мак](https://www.postgresql.org/download/macosx/), [Линукс](https://ubuntu.com/server/docs/databases-postgresql); версия не важна, но сильно низкую не стоит)
4) Github Desktop (необязательно, но удобная штука)

Также, для корректной работы необходимо установить следующие библиотеки:

SQLAlchemy, Alembic


## Теормин

### Базы данных: что это и с чем это едят
На данном этапе, вся ваша работа в Data Science - работа с базами данных. Внимание, вопрос - а что это вообще такое? База данных - своеобразное хранилище данных. Чтобы ваши данные не лежали где попало и как попало, их собирают в данные хранилища.

Рассмотрим пример: у нас есть корзина с кучей яблок. Нам надо все яблоки описать. Мы можем просто для каждого яблока написать целое сочинение и в деталях описывать все его характеристики. Либо можно пойти по умному пути: выделить какие-то общие критерии оценивания яблок. Допустим это будут: сорт, вес и цена. Добавим все наши яблоки и их свойства в таблицу: колонками будут наши свойства, а строчками - конкретные яблоки. Получится так, что каждое яблоко будет записано в таблицу, где будут перечислены его свойства.

А теперь возьмем, и по схожему принципу сделаем таблицу с грушами, или с персиками. Объединение таблиц - и есть база данных (сокращённо БД). Тоесть бд - кучка таблиц, в которых лежат какие-то значения. На нашем примере: база данных - фрукты, таблицы - яблоки, груши, персики. Значения (записи) в этих таблицах - конкретные фрукты


### SQLAlchemy: Таблицы, колонки и прочая чешуя
SQLAlchemy - главная библиотека для работы с данными в python. Позволяет использовать ORM (object-relation mapping) вместо "сырых" SQL запросов, что гораздо удобнее, эффективнее и безопаснее. Также имеет целую кучу надстроек и интеграций к примеру с FastAPI (что очень хорошо и удобно для бэка).

#### Создание таблиц и колонок в них:
В общем случае при создании таблицы нужно создать класс таблицы, унаследовать его от Base, наполнить его столбцами и начать радоваться жизни. Каво? Куда? Сейчас разберемся.

Начнем с импорта библиотек и их методов:
```python
# === Импортирование типов данных из SQLAlchemy ===
from sqlalchemy import Integer, String
# Integer - целое число, String - строка

# === Импортирование ORM методов из SQLAlchemy ===
from sqlalchemy.orm import Mapped, mapped_column

# === Импортирование базового класса таблицы ===
from .base import Base
```
По порядку
1) Типы данных SQLAlchemy - типы данных, которые будут храниться в данном столбце. ВАЖНО. Это именно SQL типы данных, а не тип данных из Python
2) Да кто эти твои ORM? ORM - своеобразная прослойка между базами данных и объектами языков программирования. В нашем случае ORM ставит типы данных из Python в соответствие с типами данных SQL.
3) Базовый класс таблицы. Класс, от которого отнаследованны все классы наших таблиц. Нужен для того, чтобы можно было пользоваться общими методами

Теперь опишем саму таблицу!
```python
# === Класс, описывающий таблицу ===
class Student(Base): # Обязательно наследуйте от BASE
    # === Описание колонок нашей таблицы ===
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    name: Mapped[str] = mapped_column(String)
    surname: Mapped[str] = mapped_column(String)
    card_number: Mapped[int] = mapped_column(String)
```
Разберем весь этот ужас на примере строчки, начинающейся с id
 1) id - название колонки
 2) Mapped[int] - type-hint. Помогает при дебаге и чтении кода. Отображает тип данных Python
 3) mapped_column - Собственно обозначение того, что id - это именно колонка
 4) Integer - тип данных SQLAlchemy, который она потом переводит в тип данных нашей БД
 5) primary_key=True - флаг, который говорит о том, что данная колонка - первичный ключ. Что это значит? Данные значения уникальны, поэтому по id можно ОДНОЗНАЧНО определить объект.

По итогу у нас получается вот такая сборная солянка:
```python
from sqlalchemy import Integer, String
from sqlalchemy.orm import Mapped, mapped_column

from .base import Base

class Student(Base):
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    name: Mapped[str] = mapped_column(String)
    surname: Mapped[str] = mapped_column(String)
    card_number: Mapped[int] = mapped_column(String)
```
Это и есть вся наша таблица. Несложно, правда? Но вот незадача: написать то мы написали, а в нашей базе данных ничего не поменялось.

### Alembic: Миграции, или почему я все написал, а в базе данных ничего нет
Alembic - Библиотека, которая базируется на SQLAlchemy. Позволяет управлять структурой базы данных посредством миграций - скриптов перехода от одной версии БД до другой. Очень удобный инструмент, позволяет четко отследить когда и что было добавлено и убрано из структуры БД.

Логично предположить, что пока мы не проведем загадочную "миграцию", ничего в базе данных не поменяется.

#### Занимательные миграции: как создать 100500 таблиц и не положить прод
При ЛЮБОМ изменении в структуре базы данных необходимо проводить миграцию - создать скрипт и выполнить его. Кстати по поводу структуры. Под структурой базы данных я понимаю: схемы, таблицы, столбцы, пользователи. Пока что alembic не умеет в управление схемами и пользователями, но это пока :)

Так как это сделать?
1) Импортировать свои классы таблиц в файле `__init__.py`. Рассмотрим на примере:
```python
# __init__.py
from .database import Student

__all__ = ["Student"]
```
Первая строчка - импортирование класса таблицы Student из файла database. Вторая - список всех классов, которые можно импортировать из этого модуля. Когда вы создаете новый класс таблицы его нужно импортировать как в примере и вписать (через запятую) в список.
2) Есть волшебная команда (проводить ее надо в терминале/командной строке): 
`alembic revision --autogenerate -m "я был тут"`

Опять же, по порядку:
1) revision - Говорит о том, что мы будем работать с ревизиями. Ревизия - по сути версия нашей базы данных
2) --autogenerate - Флаг, который делает всю работу за нас. Говорит, чтобы alembic сам нашел все изменения в структуре таблиц и записал их в скрипт миграции
3) -m "здесь могла быть ваша реклама" - Добавляет в название скрипта миграции текст в кавычках. Необязательный, но ОЧЕНЬ желательный флаг.

К примеру, мы выполнили команду `alembic revision --autogenerate`. Теперь в папке Data_science/migrations/version появился какой-то странный .py файл. Разберем теперь и его
```python
"""empty message

Revision ID: 7b76e37f7232 <- Айди, уникальный номер версии
Revises: 
Create Date: 2023-11-14 18:47:28.990118 <- Дата и время создания

"""
# === Импортирование библиотек ===
from alembic import op 
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '7b76e37f7232' # Уникальный номер версии
down_revision = None # Номер предыдущей версии
branch_labels = None # Хз вообще что это
depends_on = None # Тоже хрень какая-то

# === Блок обновления базы данных ===
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###

    # === Создание таблицы ===
    op.create_table('student',
    sa.Column('id', sa.Integer(), nullable=False), # Описание столбцов
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('surname', sa.String(), nullable=False),
    sa.Column('card_number', sa.String(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###

# === Блок "отката" версии ===
def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('student') # Удаление таблицы
    # ### end Alembic commands ###
```
Рассмотрим операцию op.create_table
1) student - название нашей таблицы (как мы видим уже маленькими буквами)
2) Перечисление столбцов этой таблицы. id - название колонки, sa.Integer() - тип данных из SQLAlchemy. nullable=False - может ли значение в данной колонке быть равным None

Замечательно, таблица создается, все колонки видны - красота одним словом. Но в базе данных ОПЯТЬ ничего не поменялось. Теперь пора применить миграцию:
`alembic upgrade head`. Эта команда найдет все непримененные скрипты миграций и применит их к нашей базе данных.

Теперь, если вы все сделали правильно, в вашей базе данных должна появится таблица students с несколькими колонками.

Бывает такое, что скрипт миграции пуст, хотя таким быть не должен. Вот пример пустого скрипта:
```python
"""empty message

Revision ID: badb46b4217d
Revises: 
Create Date: 2023-11-20 21:29:07.958002

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = 'badb46b4217d'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    pass


def downgrade():
    pass
```

В функциях upgrade и gowngrade ничего нет. Про то, как это чинить, написано дальше.

#### Помогите, я все сломал
Если вы поняли, что вы сделали не то, что надо, (не так назвали колонку/поставили в нее не тот тип данных), а миграцию уже применили, НИ В КОЕМ СЛУЧАЕ не делайте эти вещи:
1) Не паникуйте
2) Не удаляйте скрипт миграции после его применения
3) Не удаляйте таблицу alebmic_version из базы данных

Что делать надо: `alembic downgrade head-n` - откатит n последних миграций. Если надо откатить одну миграцию: `alembic downgrade head-1`


### Я все сделал, но ничего не получается
1) Если у вас генерируется пустой скрипт миграции:
   1) Проверьте, добавили ли вы в команду `alembic revision ...` флаг `--autogenerate`
   2) Проверьте, что вы отнаследовали класс своей таблицы от Base
   3) Проверьте, что вы импортировали свои классы таблиц в файле `__init__.py` и добавили их в словарик.
2) Если при выполнении команд alembic возникает ошибка: `sqlalchemy.exc.OperationalError: (psycopg2.OperationalError)` или что-то похожее на это:
   1) Это в 99% процентах случаев проблема со ссылкой на базу данных. Данная ссылка лежит в файле settings.py в 11 строчке. Проверьте ее и поменяйте при необходимости
   2) В 1% случаев это проблема с Postgresql сервером или установкой postgresql в целом. Если ошибки в ссылке точно нет, напишите мне в лс или в чат, будем думать.
3) Если вашей ошибки тут нет или если вы ничего не поняли: пишите мне, разберемся)

## Структура папки
В папке Data_science лежит несколько файлов и папок.
1) `settings.py` - Файл питона с перечислением настроек проекта. В нем есть важное поле - DB_DSN. Это ссылка на вашу базу данных.
2) `data-science-setup.md` - Файлик, который вы сейчас читаете :)
3) `alembic.ini` - Конфигурационный файл для корректной работы библиотеки alembic и миграций в целом
4) Папка migrations
   1) Папка versions - папка со всеми скриптами миграций
   2) `env.py` - конфигурационный файл alembic, по сути то, что выполняется при любом вызове `alembic revision ...`
   3) `script.py.mako` - Mako скрипт для генерации миграций
5) Папка models
   1) `__init__.py` - файл с импортом всех классов SQLAlchemy, описывающих таблицы
   2) `base.py` - файл с базовым классом таблицы.
   3) `database.py` - файл со всеми классами таблиц SQLAlchemy.

Файл database.py в нашем случае самый важный - в нем вы будете выполнять почти всю работу по задаче.


### Полезные ссылки:
Статья про базы данных - https://habr.com/ru/articles/555760/

Статья про SQLAlchemy - https://habr.com/ru/articles/470285/ (можете прочитать до раздела "Запросы и relations")

Статья про Alembic - https://habr.com/ru/companies/yandex/articles/511892/ (до раздела "Как подготовить базу?")

Ссылка на наш вики - https://github.com/profcomff/.github/wiki

Ссылка на шаблон FastAPI проекта - https://github.com/profcomff/fastapi-template


## Описание задач

Всего у вас есть три типа задач:
1) Создать строку
2) Создать колонку
3) Удалить колонку/таблицу

Описание того, что конкретно и как надо создавать лежит в чате в ТГ

### Создать колонку
Надо создать строчку в таблице с указанным типом данных, создать скрипт миграции, применить миграцию и проверить, все ли корректно отображается

### Создать таблицу
Надо создать класс, описывающий таблицу, наполнить эту таблицу колонками, создать скрипт миграции, применить миграцию и проверить, все ли создалось

Не забывайте импортировать свои классы в `__init__.py`!

### Удалить колонку/таблицу
Надо удалить уже существующую таблицу или колонку из таблицы. Создать скрипт миграции, провести миграцию и проверить, все ли удалилось.

Не забудьте удалить импорт удаленной таблицы из `__init__.py`!

# Всем Удачи!
